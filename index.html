<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة كروت البنزين - شركة نايف للأغذية</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- مكتبات جديدة -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root {
            --primary-color: #FF9800;
            --secondary-color: #00FFAA;
            --background-color: #E3F2FD;
            --accent-blue: #1565C0;
            --text-color: #333;
            --light-text: #777;
            --card-bg: #FFFFFF;
            --border-radius: 10px;
            --box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            min-height: 100vh;
            padding-bottom: 100px;
        }

        .container {
            max-width: 1135px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background: linear-gradient(to left, var(--primary-color), var(--secondary-color));
            color: #333;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--box-shadow);
            border-bottom: 5px solid var(--accent-blue);
        }

        .logo-container {
            display: flex;
            align-items: center;
        }

        .logo {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin-left: 15px;
            border: 3px solid white;
            background-image: url('https://i.postimg.cc/NM2zJWZD/NAIF-LOGO.jpg');
            background-size: cover;
            background-position: center;
        }

        .header-info h1 {
            font-size: 28px;
            margin-bottom: 5px;
            color: #333;
            text-shadow: 1px 1px 2px rgba(255, 255, 255, 0.8);
        }

        .header-info p {
            font-size: 16px;
            color: #444;
            font-weight: 600;
        }

        .date-info {
            text-align: left;
            background-color: rgba(255, 255, 255, 0.7);
            padding: 10px 15px;
            border-radius: var(--border-radius);
            color: #333;
            font-weight: 600;
            border: 2px solid var(--accent-blue);
        }

        .tabs {
            display: flex;
            background-color: white;
            border-radius: var(--border-radius);
            margin-bottom: 30px;
            overflow: hidden;
            box-shadow: var(--box-shadow);
        }

        .tab {
            flex: 1;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            color: #555;
        }

        .tab:hover {
            background-color: rgba(255, 152, 0, 0.1);
            color: var(--primary-color);
        }

        .tab.active {
            background-color: rgba(255, 152, 0, 0.1);
            border-bottom: 3px solid var(--primary-color);
            color: var(--primary-color);
        }

        .tab-content {
            display: none;
            background-color: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .tab-content h2 {
            color: var(--accent-blue);
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--secondary-color);
            display: flex;
            align-items: center;
        }

        .tab-content h2 i {
            margin-left: 10px;
            color: var(--primary-color);
        }

        .floating-cards {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        .floating-card {
            flex: 1;
            min-width: 200px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--box-shadow);
            display: flex;
            align-items: center;
            transition: transform 0.3s ease;
            border-top: 5px solid var(--primary-color);
        }

        .floating-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
        }

        .floating-card i {
            font-size: 40px;
            margin-left: 15px;
            color: var(--accent-blue);
        }

        .card-info h3 {
            font-size: 14px;
            color: var(--light-text);
            margin-bottom: 5px;
        }

        .card-info p {
            font-size: 28px;
            font-weight: bold;
            color: var(--accent-blue);
        }

        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: var(--border-radius);
            border: 1px solid #ddd;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 0;
        }

        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: var(--accent-blue);
            color: white;
            font-weight: 600;
        }

        tr:hover {
            background-color: rgba(21, 101, 192, 0.05);
        }

        /* تحسين النماذج لتكون في صف واحد */
        .compact-form {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            align-items: flex-end;
        }

        .form-group {
            flex: 1;
            min-width: 180px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--accent-blue);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: border 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-blue);
            box-shadow: 0 0 0 2px rgba(21, 101, 192, 0.2);
        }

        /* قائمة الاقتراحات للكروت */
        .suggestions-container {
            position: relative;
        }
        
        .suggestions-list {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
            display: none;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .suggestion-item {
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .suggestion-item:hover {
            background-color: rgba(21, 101, 192, 0.1);
        }

        .btn {
            display: inline-block;
            padding: 12px 25px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background-color: #e68900;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }

        .btn-blue {
            background-color: var(--accent-blue);
        }

        .btn-blue:hover {
            background-color: #0d47a1;
        }

        .btn-green {
            background-color: var(--secondary-color);
            color: #333;
        }

        .btn-green:hover {
            background-color: #00cc99;
        }

        .btn-small {
            padding: 8px 15px;
            font-size: 14px;
        }

        .btn-red {
            background-color: #ff4444;
        }

        .btn-red:hover {
            background-color: #cc0000;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .compact-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .floating-shortcuts {
            position: fixed;
            bottom: 120px;
            left: 30px;
            z-index: 100;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .floating-shortcut {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid white;
        }

        .floating-shortcut:hover {
            transform: scale(1.1);
            background-color: #e68900;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
        }

        .floating-shortcut.blue {
            background-color: var(--accent-blue);
        }

        .floating-shortcut.blue:hover {
            background-color: #0d47a1;
        }

        .floating-shortcut.green {
            background-color: var(--secondary-color);
            color: #333;
        }

        .floating-shortcut.green:hover {
            background-color: #00cc99;
        }

        footer {
            text-align: center;
            margin-top: 50px;
            padding: 20px;
            color: var(--light-text);
            border-top: 1px solid #ddd;
        }

        .alert {
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            display: none;
        }

        .alert.success {
            background-color: rgba(0, 255, 170, 0.2);
            border-right: 5px solid var(--secondary-color);
            color: #006644;
        }

        .alert.error {
            background-color: rgba(255, 0, 0, 0.1);
            border-right: 5px solid #ff4444;
            color: #990000;
        }

        .signature-card {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: linear-gradient(135deg, #FF746C, #FF6E00, #80EF80,#2196F3);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.3);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            z-index: 1000;
            animation: float 6s ease-in-out infinite;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 2px solid rgba(255,255,255,0.2);
            transform: scale(0.9);
            transform-origin: left bottom;
        }
        
        .signature-card:hover { 
            transform: scale(0.95); 
            box-shadow: 0 12px 35px rgba(0,0,0,0.4); 
        }
        
        @keyframes float { 
            0% { transform: scale(0.9) translateY(0px); } 
            50% { transform: scale(0.9) translateY(-15px); } 
            100% { transform: scale(0.9) translateY(0px); } 
        }
        
        .signature-card::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px; right: -2px; bottom: -2px;
            background: linear-gradient(135deg, #FF746C, #FF6E00, #80EF80,#2196F3);
            border-radius: 14px;
            z-index: -1;
            animation: borderGlow 3s linear infinite;
            background-size: 400%;
        }
        
        @keyframes borderGlow { 
            0% { background-position: 0% 50%; } 
            50% { background-position: 100% 50%; } 
            100% { background-position: 0% 50%; } 
        }
        
        .signature-card .name { 
            font-size: 1.3rem; 
            font-weight: 700; 
            margin-bottom: 5px; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.3); 
        }
        
        .signature-card .title { 
            font-size: 0.9rem; 
            opacity: 0.9; 
            font-weight: 500; 
        }
        
        @media (max-width: 768px) { 
            .signature-card { 
                position: relative; 
                bottom: auto; 
                left: auto; 
                margin: 20px auto 0; 
                width: fit-content; 
                animation: none; 
                transform: none !important; 
            } 
            
            .signature-card:hover { 
                transform: none !important; 
            } 
            
            .floating-shortcuts {
                bottom: 150px;
                left: 15px;
            }
            
            .compact-form {
                flex-direction: column;
            }
            
            .form-group {
                min-width: 100%;
            }
            
            .compact-buttons {
                flex-direction: column;
            }
            
            .compact-buttons .btn {
                width: 100%;
            }
        }

        /* ألوان للسحب والشحن في التقارير */
        .withdrawal-amount {
            color: #ff4444;
            font-weight: bold;
        }
        
        .recharge-amount {
            color: #00aa44;
            font-weight: bold;
        }
        
        .final-balance {
            background-color: #1565C0 !important;
            color: white !important;
            font-weight: bold;
        }
        
        .custom-date-range {
            display: none;
            margin-top: 10px;
        }
        
        .with-negative {
            color: #ff4444;
        }
        
        .backup-controls {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
            padding: 15px;
            background-color: #f5f5f5;
            border-radius: var(--border-radius);
        }
        
        .empty-cell {
            color: #999;
            font-style: italic;
        }
        
        .summary-row {
            background-color: #f0f7ff !important;
            font-weight: bold !important;
        }
        
        .summary-row td {
            border-top: 2px solid #1565C0;
            border-bottom: 2px solid #1565C0;
        }
        
        .compact-report-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
            align-items: flex-end;
        }
        
        .compact-report-controls .form-group {
            flex: 1;
            min-width: 200px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
        }

        /* تحسينات لاستعادة النسخ الاحتياطي */
        .backup-instructions {
            background-color: #e7f3ff;
            border-right: 5px solid #2196F3;
            padding: 15px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
        }
        
        .backup-instructions h4 {
            margin-bottom: 10px;
            color: #1565C0;
        }
        
        .backup-instructions ol {
            margin-right: 20px;
            margin-top: 10px;
        }
        
        .backup-preview {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            padding: 10px;
            background-color: #f9f9f9;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <div class="logo"></div>
                <div class="header-info">
                    <h1>شركة نايف للأغذية</h1>
                    <p>نظام إدارة كروت شحن البنزين - الكويت</p>
                </div>
            </div>
            <div class="date-info">
                <p id="current-date"></p>
                <p id="current-time"></p>
            </div>
        </header>

        <div class="floating-cards">
            <div class="floating-card">
                <i class="fas fa-gas-pump"></i>
                <div class="card-info">
                    <h3>إجمالي الكروت</h3>
                    <p id="total-cards">18</p>
                </div>
            </div>
            <div class="floating-card">
                <i class="fas fa-wallet"></i>
                <div class="card-info">
                    <h3>إجمالي الرصيد</h3>
                    <p id="total-balance">0</p>
                </div>
            </div>
            <div class="floating-card">
                <i class="fas fa-exchange-alt"></i>
                <div class="card-info">
                    <h3>عمليات اليوم</h3>
                    <p id="today-transactions">0</p>
                </div>
            </div>
            <div class="floating-card">
                <i class="fas fa-chart-line"></i>
                <div class="card-info">
                    <h3>إجمالي السحب</h3>
                    <p id="total-withdrawals">0</p>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="switchTab('opening-balance')">
                <i class="fas fa-coins"></i> الأرصدة الافتتاحية
            </div>
            <div class="tab" onclick="switchTab('daily-transaction')">
                <i class="fas fa-file-invoice-dollar"></i> الحركة اليومية
            </div>
            <div class="tab" onclick="switchTab('recharge-cards')">
                <i class="fas fa-credit-card"></i> شحن الكروت
            </div>
            <div class="tab" onclick="switchTab('movement-report')">
                <i class="fas fa-chart-bar"></i> كشف الحركة
            </div>
            <div class="tab" onclick="switchTab('reports')">
                <i class="fas fa-chart-pie"></i> التقارير والرسوم
            </div>
            <div class="tab" onclick="switchTab('backup')">
                <i class="fas fa-database"></i> النسخ الاحتياطي
            </div>
        </div>

        <div id="alert-message" class="alert"></div>

        <!-- محتوى التبويب 1: الأرصدة الافتتاحية -->
        <div id="opening-balance" class="tab-content active">
            <h2><i class="fas fa-coins"></i> تسجيل الأرصدة الافتتاحية للكروت</h2>
            <p>قم بإدخال الرصيد الافتتاحي لكل كارت من كروت الشحن.</p>
            
            <div class="compact-form">
                <div class="form-group">
                    <label for="card-number-input">رقم الكارت</label>
                    <div class="suggestions-container">
                        <input type="text" id="card-number-input" class="form-control" placeholder="ابدأ بكتابة رقم الكارت">
                        <div class="suggestions-list" id="card-suggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="opening-balance-date">تاريخ التسجيل</label>
                    <input type="date" id="opening-balance-date" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="card-holder">اسم حامل الكارت (اختياري)</label>
                    <input type="text" id="card-holder" class="form-control" placeholder="اسم حامل الكارت">
                </div>
                
                <div class="form-group">
                    <label for="opening-balance-input">الرصيد الافتتاحي</label>
                    <input type="number" id="opening-balance-input" class="form-control" placeholder="الرصيد الافتتاحي" step="0.001" min="0">
                </div>
                
                <div class="compact-buttons">
                    <button class="btn btn-blue" onclick="saveOpeningBalance()">
                        <i class="fas fa-save"></i> حفظ
                    </button>
                    <button class="btn" onclick="showAddCardModal()">
                        <i class="fas fa-plus"></i> إضافة كارت
                    </button>
                </div>
            </div>
            
            <h3 style="margin-top: 30px;">الكروت المسجلة</h3>
            <div class="table-container">
                <table id="cards-table">
                    <thead>
                        <tr>
                            <th>رقم الكارت</th>
                            <th>اسم الحامل</th>
                            <th>الرصيد الافتتاحي</th>
                            <th>الرصيد الحالي</th>
                            <th>تاريخ التسجيل</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="cards-table-body">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- محتوى التبويب 2: الحركة اليومية -->
        <div id="daily-transaction" class="tab-content">
            <h2><i class="fas fa-file-invoice-dollar"></i> تسجيل الحركة اليومية (سحب)</h2>
            <p>قم بتسجيل عمليات السحب اليومية من الكروت.</p>
            
            <div class="compact-form">
                <div class="form-group">
                    <label for="withdraw-card-input">رقم كارت السحب</label>
                    <div class="suggestions-container">
                        <input type="text" id="withdraw-card-input" class="form-control" placeholder="ابدأ بكتابة رقم الكارت">
                        <div class="suggestions-list" id="withdraw-suggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="withdraw-date">تاريخ السحب</label>
                    <input type="date" id="withdraw-date" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="withdraw-amount">مبلغ السحب</label>
                    <input type="number" id="withdraw-amount" class="form-control" placeholder="مبلغ السحب" step="0.001" min="0">
                </div>
                
                <div class="form-group">
                    <label for="withdraw-description">وصف السحب (اختياري)</label>
                    <input type="text" id="withdraw-description" class="form-control" placeholder="وصف السحب">
                </div>
                
                <button class="btn btn-blue" onclick="saveWithdrawal()">
                    <i class="fas fa-check-circle"></i> تسجيل السحب
                </button>
            </div>
            
            <h3 style="margin-top: 30px;">عمليات السحب اليومية</h3>
            <div class="table-container">
                <table id="withdrawals-table">
                    <thead>
                        <tr>
                            <th>رقم الكارت</th>
                            <th>اسم الحامل</th>
                            <th>المبلغ</th>
                            <th>التاريخ</th>
                            <th>الوصف</th>
                            <th>الوقت</th>
                        </tr>
                    </thead>
                    <tbody id="withdrawals-table-body">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- محتوى التبويب 3: شحن الكروت -->
        <div id="recharge-cards" class="tab-content">
            <h2><i class="fas fa-credit-card"></i> شحن الكروت بالفلوس</h2>
            <p>قم بإضافة رصيد جديد للكروت.</p>
            
            <div class="compact-form">
                <div class="form-group">
                    <label for="recharge-card-input">رقم كارت الشحن</label>
                    <div class="suggestions-container">
                        <input type="text" id="recharge-card-input" class="form-control" placeholder="ابدأ بكتابة رقم الكارت">
                        <div class="suggestions-list" id="recharge-suggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="recharge-date">تاريخ الشحن</label>
                    <input type="date" id="recharge-date" class="form-control">
                </div>
                
                <div class="form-group">
                    <label for="recharge-amount">مبلغ الشحن</label>
                    <input type="number" id="recharge-amount" class="form-control" placeholder="مبلغ الشحن" step="0.001" min="0">
                </div>
                
                <div class="form-group">
                    <label for="recharge-description">وصف الشحن (اختياري)</label>
                    <input type="text" id="recharge-description" class="form-control" placeholder="وصف الشحن">
                </div>
                
                <button class="btn btn-green" onclick="saveRecharge()">
                    <i class="fas fa-charging-station"></i> تنفيذ الشحن
                </button>
            </div>
            
            <h3 style="margin-top: 30px;">عمليات الشحن الأخيرة</h3>
            <div class="table-container">
                <table id="recharges-table">
                    <thead>
                        <tr>
                            <th>رقم الكارت</th>
                            <th>اسم الحامل</th>
                            <th>المبلغ</th>
                            <th>التاريخ</th>
                            <th>الوصف</th>
                            <th>الوقت</th>
                        </tr>
                    </thead>
                    <tbody id="recharges-table-body">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- محتوى التبويب 4: كشف الحركة -->
        <div id="movement-report" class="tab-content">
            <h2><i class="fas fa-chart-bar"></i> كشف حركة الكروت</h2>
            <p>اختر كارت لعرض كشف حركته الكامل.</p>
            
            <div class="compact-report-controls">
                <div class="form-group">
                    <label for="report-card-input">رقم الكارت</label>
                    <div class="suggestions-container">
                        <input type="text" id="report-card-input" class="form-control" placeholder="ابدأ بكتابة رقم الكارت">
                        <div class="suggestions-list" id="report-suggestions"></div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="report-period">الفترة الزمنية</label>
                    <select id="report-period" class="form-control" onchange="toggleCustomDateRange()">
                        <option value="all">كل الفترات</option>
                        <option value="today">اليوم</option>
                        <option value="week">الأسبوع الحالي</option>
                        <option value="month">الشهر الحالي</option>
                        <option value="year">السنة الحالية</option>
                        <option value="custom">فترة مخصصة</option>
                    </select>
                </div>
                
                <div class="compact-buttons">
                    <button class="btn btn-blue" onclick="generateReport()">
                        <i class="fas fa-search"></i> عرض التقرير
                    </button>
                    
                    <div class="export-buttons">
                        <button class="btn" onclick="exportToPDF()" title="تصدير PDF">
                            <i class="fas fa-file-pdf"></i>
                        </button>
                        <button class="btn btn-green" onclick="exportToExcel()" title="تصدير Excel">
                            <i class="fas fa-file-excel"></i>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="custom-date-range" id="custom-date-range">
                <div class="compact-form">
                    <div class="form-group">
                        <label for="start-date">من تاريخ</label>
                        <input type="date" id="start-date" class="form-control">
                    </div>
                    
                    <div class="form-group">
                        <label for="end-date">إلى تاريخ</label>
                        <input type="date" id="end-date" class="form-control">
                    </div>
                </div>
            </div>
            
            <h3 id="report-title" style="margin-top: 30px;"></h3>
            <div class="table-container">
                <table id="report-table">
                    <thead>
                        <tr>
                            <th>التاريخ</th>
                            <th>نوع الحركة</th>
                            <th>المبلغ</th>
                            <th>الوصف</th>
                            <th>الرصيد بعد الحركة</th>
                        </tr>
                    </thead>
                    <tbody id="report-table-body">
                    </tbody>
                </table>
            </div>
        </div>

        <!-- محتوى التبويب 5: التقارير والرسوم -->
        <div id="reports" class="tab-content">
            <h2><i class="fas fa-chart-pie"></i> التقارير والرسوم البيانية</h2>
            <p>إحصائيات وتحليلات حول استخدام كروت الشحن.</p>
            
            <div style="margin-top: 30px;">
                <h3>إحصائيات عامة</h3>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>الكارت (الرقم الكامل)</th>
                                <th>إجمالي السحب</th>
                                <th>إجمالي الشحن</th>
                                <th>صافي الحركة</th>
                                <th>متوسط السحب اليومي</th>
                                <th>عدد العمليات</th>
                            </tr>
                        </thead>
                        <tbody id="statistics-table-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- محتوى التبويب 6: النسخ الاحتياطي -->
        <div id="backup" class="tab-content">
            <h2><i class="fas fa-database"></i> النسخ الاحتياطي واستعادة البيانات</h2>
            <p>احفظ نسخة احتياطية من جميع بيانات النظام أو استرجعها من نسخة سابقة.</p>
            
            <div class="backup-instructions">
                <h4><i class="fas fa-info-circle"></i> كيفية الاستعادة:</h4>
                <p>للاستعادة من نسخة احتياطية محددة:</p>
                <ol>
                    <li>ابحث عن النسخة المطلوبة في الجدول أدناه</li>
                    <li>انظر إلى العمود "الإجراءات" في أقصى اليمين</li>
                    <li>اضغط على زر <button class="btn btn-small btn-green" disabled><i class="fas fa-undo"></i> استعادة</button> بجوار النسخة المطلوبة</li>
                    <li>ستظهر لك نافذة تأكيد - اضغط "موافق" للمتابعة</li>
                </ol>
                <p style="margin-top: 10px; color: #d32f2f;">
                    <i class="fas fa-exclamation-triangle"></i> تحذير: الاستعادة ستحل محل جميع البيانات الحالية!
                </p>
            </div>
            
            <div class="backup-controls">
                <div>
                    <h3>النسخ الاحتياطي التلقائي</h3>
                    <p>يتم حفظ نسخة احتياطية تلقائيًا كل 
                        <select id="backup-interval" onchange="changeBackupInterval(this.value)">
                            <option value="1">ساعة واحدة</option>
                            <option value="6">6 ساعات</option>
                            <option value="12">12 ساعة</option>
                            <option value="24" selected>24 ساعة</option>
                            <option value="48">48 ساعة</option>
                        </select>
                    </p>
                    <p>آخر نسخة احتياطية: <span id="last-backup-time">لم يتم بعد</span></p>
                    <p>عدد النسخ المحفوظة: <span id="backup-count">0</span> نسخة</p>
                    <div style="margin-top: 10px;">
                        <button class="btn btn-small" onclick="openDataFolder()">
                            <i class="fas fa-folder-open"></i> فتح مجلد البيانات
                        </button>
                        <button class="btn btn-small" onclick="openBackupFolder()">
                            <i class="fas fa-folder-open"></i> فتح مجلد النسخ الاحتياطي
                        </button>
                    </div>
                </div>
                
                <div style="display: flex; flex-direction: column; gap: 10px;">
                    <button class="btn btn-blue" onclick="createBackup()">
                        <i class="fas fa-save"></i> إنشاء نسخة احتياطية يدوية
                    </button>
                    
                    <!-- استعادة سريعة -->
                    <div class="form-group" style="min-width: 250px;">
                        <label for="quick-restore-select">استعادة سريعة:</label>
                        <div style="display: flex; gap: 10px;">
                            <select id="quick-restore-select" class="form-control" style="flex: 1;">
                                <option value="">-- اختر نسخة للاستعادة --</option>
                            </select>
                            <button class="btn btn-green" onclick="quickRestore()" style="white-space: nowrap;">
                                <i class="fas fa-undo"></i> استعادة
                            </button>
                        </div>
                    </div>
                    
                    <button class="btn" onclick="restoreBackup()">
                        <i class="fas fa-history"></i> استعادة متقدمة
                    </button>
                    
                    <button class="btn btn-red" onclick="resetSystem()">
                        <i class="fas fa-trash"></i> إعادة ضبط النظام
                    </button>
                </div>
            </div>
            
            <h3 style="margin-top: 30px;">النسخ الاحتياطية المتاحة (من الأحدث إلى الأقدم)</h3>
            <div class="table-container">
                <table id="backup-table">
                    <thead>
                        <tr>
                            <th>#</th>
                            <th>تاريخ النسخة</th>
                            <th>عدد الكروت</th>
                            <th>عدد الحركات</th>
                            <th>حجم البيانات</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody id="backup-table-body">
                        <!-- سيتم تعبئته بواسطة JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="floating-shortcuts">
            <div class="floating-shortcut blue" onclick="switchTab('opening-balance')" title="الأرصدة الافتتاحية">
                <i class="fas fa-coins"></i>
            </div>
            <div class="floating-shortcut" onclick="switchTab('daily-transaction')" title="الحركة اليومية">
                <i class="fas fa-gas-pump"></i>
            </div>
            <div class="floating-shortcut green" onclick="switchTab('recharge-cards')" title="شحن الكروت">
                <i class="fas fa-bolt"></i>
            </div>
            <div class="floating-shortcut blue" onclick="switchTab('movement-report')" title="كشف الحركة">
                <i class="fas fa-chart-line"></i>
            </div>
        </div>
    </div>

    <footer>
        <p>نظام إدارة كروت شحن البنزين - شركة نايف للأغذية &copy; الكويت</p>
        <p>تم التطوير البرنامج بواسطة ياسر الخطيب 67011143</p>
    </footer>

    <!-- نافذة إضافة كارت جديد -->
    <div id="new-card-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 30px; border-radius: var(--border-radius); width: 90%; max-width: 500px;">
            <h3 style="margin-bottom: 20px; color: var(--accent-blue);">إضافة كارت جديد</h3>
            <div class="form-group">
                <label for="new-card-number">رقم الكارت الجديد</label>
                <input type="text" id="new-card-number" class="form-control" placeholder="أدخل رقم الكارت الجديد">
            </div>
            <div class="form-group">
                <label for="new-card-holder">اسم حامل الكارت (اختياري)</label>
                    <input type="text" id="new-card-holder" class="form-control" placeholder="أدخل اسم حامل الكارت">
            </div>
            <div class="button-group">
                <button class="btn btn-blue" onclick="saveNewCard()">حفظ</button>
                <button class="btn" onclick="hideAddCardModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نافذة استعادة النسخة الاحتياطية -->
    <div id="restore-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
        <div style="background-color: white; padding: 30px; border-radius: var(--border-radius); width: 90%; max-width: 500px;">
            <h3 style="margin-bottom: 20px; color: var(--accent-blue);">استعادة نسخة احتياطية</h3>
            <div class="form-group">
                <label for="backup-select">اختر النسخة للاستعادة</label>
                <select id="backup-select" class="form-control">
                    <option value="">-- اختر نسخة --</option>
                </select>
            </div>
            <div class="alert" id="restore-alert" style="display: none; margin-bottom: 15px;"></div>
            <div class="button-group">
                <button class="btn btn-green" onclick="confirmRestore()">تأكيد الاستعادة</button>
                <button class="btn" onclick="hideRestoreModal()">إلغاء</button>
            </div>
        </div>
    </div>

    <!-- نافذة معاينة النسخة الاحتياطية -->
    <div id="preview-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;"></div>

    <div class="signature-card">
        <div class="name">Yasser Elkhateeb</div>
        <div class="title">مطور البرنامج 67011143</div>
    </div>

    <script>
        // البيانات الأساسية
        const initialCards = [
            "7005430001001413361",
            "7005430001000221425",
            "7005430001001610779",
            "7005430001001415797",
            "7005430001001415789",
            "7005430001001610778",
            "7005430001001415787",
            "7005430001001415774",
            "7005430001001413960",
            "7005430001001397772",
            "7005430001001415785",
            "7005430001001415788",
            "7005430001001610780",
            "7005430001001610777",
            "7005430001001415790",
            "7005430001001415784",
            "7005430001001339950",
            "7005430001001415786"
        ];

        // بيانات التطبيق
        let appData = {
            cards: {},
            transactions: []
        };

        // بيانات النسخ الاحتياطي
        let backupData = {
            backups: [],
            lastBackup: null
        };

        // إعدادات النسخ الاحتياطي
        let backupSettings = {
            autoBackupIntervalHours: 24, // قيمة افتراضية 24 ساعة
            maxBackupsToKeep: 10
        };

        // التحقق من وجود واجهة Electron
        const isElectron = typeof window.electronAPI !== 'undefined';

        // تحميل البيانات من نظام الملفات (Electron) أو localStorage (ويب)
        async function loadData() {
            try {
                // تحميل إعدادات النسخ الاحتياطي
                await loadBackupSettings();
                
                if (isElectron) {
                    // استدعاء Electron API لإنشاء المجلدات
                    await window.electronAPI.ensureDirs();
                    
                    // تحميل البيانات الرئيسية من نظام الملفات
                    const appDataResult = await window.electronAPI.loadData();
                    
                    if (appDataResult.success && appDataResult.data) {
                        appData = appDataResult.data;
                    } else {
                        // تهيئة البيانات الأولية
                        initialCards.forEach(cardNumber => {
                            appData.cards[cardNumber] = {
                                cardNumber: cardNumber,
                                holderName: "",
                                openingBalance: 0,
                                currentBalance: 0,
                                openingDate: new Date().toISOString().split('T')[0],
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            };
                        });
                        await saveData();
                    }
                    
                    // تحميل بيانات النسخ الاحتياطي من نظام الملفات
                    const backupResult = await window.electronAPI.loadBackupData();
                    
                    if (backupResult.success && backupResult.data) {
                        backupData = backupResult.data;
                    } else {
                        backupData = {
                            backups: [],
                            lastBackup: null
                        };
                        await saveBackupData();
                    }
                } else {
                    // استخدام localStorage في حالة الويب
                    const savedData = localStorage.getItem('fuelCardSystem');
                    const savedBackup = localStorage.getItem('fuelCardBackup');
                    
                    if (savedData) {
                        appData = JSON.parse(savedData);
                    } else {
                        initialCards.forEach(cardNumber => {
                            appData.cards[cardNumber] = {
                                cardNumber: cardNumber,
                                holderName: "",
                                openingBalance: 0,
                                currentBalance: 0,
                                openingDate: new Date().toISOString().split('T')[0],
                                createdAt: new Date().toISOString(),
                                updatedAt: new Date().toISOString()
                            };
                        });
                        saveData();
                    }
                    
                    if (savedBackup) {
                        backupData = JSON.parse(savedBackup);
                    } else {
                        backupData = {
                            backups: [],
                            lastBackup: null
                        };
                        saveBackupData();
                    }
                }
                
                updateUI();
                updateBackupTable();
                checkAutoBackup();
                setupAutocomplete();
                
            } catch (error) {
                console.error('Error loading data:', error);
                showAlert('حدث خطأ في تحميل البيانات', 'error');
            }
        }

        // تحميل إعدادات النسخ الاحتياطي
        async function loadBackupSettings() {
            const savedSettings = localStorage.getItem('backupSettings');
            if (savedSettings) {
                backupSettings = JSON.parse(savedSettings);
            }
            
            // تحديث القيم في الواجهة
            const intervalSelect = document.getElementById('backup-interval');
            if (intervalSelect) {
                intervalSelect.value = backupSettings.autoBackupIntervalHours;
            }
        }

        // حفظ إعدادات النسخ الاحتياطي
        function saveBackupSettings() {
            localStorage.setItem('backupSettings', JSON.stringify(backupSettings));
        }

        // تغيير فاصل النسخ الاحتياطي
        function changeBackupInterval(hours) {
            backupSettings.autoBackupIntervalHours = parseInt(hours);
            saveBackupSettings();
            showAlert(`تم تغيير فاصل النسخ الاحتياطي إلى ${hours} ساعة`, 'success');
        }

        // حفظ البيانات في نظام الملفات (Electron) أو localStorage (ويب)
        async function saveData() {
            try {
                if (isElectron) {
                    const result = await window.electronAPI.saveData(appData);
                    if (!result.success) {
                        console.error('Error saving data:', result.error);
                        showAlert('حدث خطأ في حفظ البيانات', 'error');
                    }
                } else {
                    localStorage.setItem('fuelCardSystem', JSON.stringify(appData));
                }
            } catch (error) {
                console.error('Error saving data:', error);
                showAlert('حدث خطأ في حفظ البيانات', 'error');
            }
        }

        // حفظ بيانات النسخ الاحتياطي في نظام الملفات (Electron) أو localStorage (ويب)
        async function saveBackupData() {
            try {
                if (isElectron) {
                    const result = await window.electronAPI.saveBackupData(backupData);
                    if (!result.success) {
                        console.error('Error saving backup data:', result.error);
                    }
                } else {
                    localStorage.setItem('fuelCardBackup', JSON.stringify(backupData));
                }
            } catch (error) {
                console.error('Error saving backup data:', error);
            }
        }

        // فتح مجلد البيانات
        async function openDataFolder() {
            if (isElectron) {
                try {
                    await window.electronAPI.openDataFolder();
                } catch (error) {
                    console.error('Error opening data folder:', error);
                    showAlert('حدث خطأ في فتح المجلد', 'error');
                }
            } else {
                showAlert('هذه الميزة متاحة فقط في نسخة التطبيق المحلية', 'error');
            }
        }

        // فتح مجلد النسخ الاحتياطي
        async function openBackupFolder() {
            if (isElectron) {
                try {
                    await window.electronAPI.openBackupFolder();
                } catch (error) {
                    console.error('Error opening backup folder:', error);
                    showAlert('حدث خطأ في فتح المجلد', 'error');
                }
            } else {
                showAlert('هذه الميزة متاحة فقط في نسخة التطبيق المحلية', 'error');
            }
        }

        // إعداد وظيفة الاكتمال التلقائي
        function setupAutocomplete() {
            // قائمة بحقول الإدخال التي تحتاج إلى اكتمال تلقائي
            const autocompleteFields = [
                { id: 'card-number-input', suggestionsId: 'card-suggestions' },
                { id: 'withdraw-card-input', suggestionsId: 'withdraw-suggestions' },
                { id: 'recharge-card-input', suggestionsId: 'recharge-suggestions' },
                { id: 'report-card-input', suggestionsId: 'report-suggestions' }
            ];
            
            autocompleteFields.forEach(field => {
                const input = document.getElementById(field.id);
                const suggestions = document.getElementById(field.suggestionsId);
                
                if (input && suggestions) {
                    input.addEventListener('input', function() {
                        const searchTerm = this.value.trim();
                        showSuggestions(searchTerm, suggestions, this);
                    });
                    
                    input.addEventListener('focus', function() {
                        const searchTerm = this.value.trim();
                        showSuggestions(searchTerm, suggestions, this);
                    });
                    
                    // إغلاق قائمة الاقتراحات عند النقر خارجها
                    document.addEventListener('click', function(e) {
                        if (!input.contains(e.target) && !suggestions.contains(e.target)) {
                            suggestions.style.display = 'none';
                        }
                    });
                }
            });
        }

        // عرض الاقتراحات
        function showSuggestions(searchTerm, suggestionsContainer, inputElement) {
            suggestionsContainer.innerHTML = '';
            
            if (!searchTerm) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            const suggestions = [];
            
            for (const cardNumber in appData.cards) {
                const card = appData.cards[cardNumber];
                const cardDisplay = `${cardNumber} ${card.holderName ? `(${card.holderName})` : ''}`;
                
                if (cardNumber.includes(searchTerm) || 
                    (card.holderName && card.holderName.includes(searchTerm))) {
                    suggestions.push({
                        display: cardDisplay,
                        cardNumber: cardNumber
                    });
                }
            }
            
            if (suggestions.length === 0) {
                suggestionsContainer.style.display = 'none';
                return;
            }
            
            suggestions.forEach(suggestion => {
                const div = document.createElement('div');
                div.className = 'suggestion-item';
                div.textContent = suggestion.display;
                div.addEventListener('click', function() {
                    inputElement.value = suggestion.cardNumber;
                    suggestionsContainer.style.display = 'none';
                });
                suggestionsContainer.appendChild(div);
            });
            
            suggestionsContainer.style.display = 'block';
        }

        // تحديث واجهة المستخدم
        function updateUI() {
            updateCardsTable();
            updateFloatingCards();
            updateTransactionsTables();
            updateStatisticsTable();
        }

        // تحديث جدول الكروت
        function updateCardsTable() {
            const tbody = document.getElementById('cards-table-body');
            tbody.innerHTML = '';
            
            let totalBalance = 0;
            let cardsCount = 0;
            
            for (const cardNumber in appData.cards) {
                const card = appData.cards[cardNumber];
                cardsCount++;
                totalBalance += card.currentBalance;
                
                const openingBalanceDisplay = card.openingBalance && card.openingBalance !== 0 ? 
                    card.openingBalance.toFixed(3) : '<span class="empty-cell">-</span>';
                const currentBalanceDisplay = card.currentBalance && card.currentBalance !== 0 ? 
                    card.currentBalance.toFixed(3) : '<span class="empty-cell">-</span>';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${card.cardNumber}</td>
                    <td>${card.holderName || '-'}</td>
                    <td>${openingBalanceDisplay}</td>
                    <td>${currentBalanceDisplay}</td>
                    <td>${card.openingDate || formatDate(card.createdAt)}</td>
                    <td>
                        <button class="btn btn-small" onclick="editCard('${card.cardNumber}')">
                            <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="btn btn-small btn-blue" onclick="rechargeFromTable('${card.cardNumber}')">
                            <i class="fas fa-charging-station"></i> شحن
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            }
            
            document.getElementById('total-cards').textContent = cardsCount;
            document.getElementById('total-balance').textContent = totalBalance !== 0 ? totalBalance.toFixed(3) : '-';
        }

        // تحديث الكروت الإحصائية
        function updateFloatingCards() {
            let todayTransactions = 0;
            let totalWithdrawals = 0;
            const today = new Date().toDateString();
            
            appData.transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date).toDateString();
                if (transactionDate === today) {
                    todayTransactions++;
                }
                
                if (transaction.type === 'withdrawal') {
                    totalWithdrawals += transaction.amount;
                }
            });
            
            document.getElementById('today-transactions').textContent = todayTransactions;
            document.getElementById('total-withdrawals').textContent = totalWithdrawals !== 0 ? totalWithdrawals.toFixed(3) : '-';
        }

        // تحديث جداول الحركات
        function updateTransactionsTables() {
            // تحديث جدول السحوبات
            const withdrawalsTbody = document.getElementById('withdrawals-table-body');
            withdrawalsTbody.innerHTML = '';
            
            const recentWithdrawals = appData.transactions
                .filter(t => t.type === 'withdrawal')
                .slice(-10)
                .reverse();
            
            recentWithdrawals.forEach(transaction => {
                const card = appData.cards[transaction.cardNumber] || {};
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.cardNumber}</td>
                    <td>${card.holderName || '-'}</td>
                    <td class="with-negative">-${transaction.amount.toFixed(3)}</td>
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.description || '-'}</td>
                    <td>${formatTime(transaction.timestamp)}</td>
                `;
                withdrawalsTbody.appendChild(row);
            });
            
            // تحديث جدول الشحن
            const rechargesTbody = document.getElementById('recharges-table-body');
            rechargesTbody.innerHTML = '';
            
            const recentRecharges = appData.transactions
                .filter(t => t.type === 'recharge')
                .slice(-10)
                .reverse();
            
            recentRecharges.forEach(transaction => {
                const card = appData.cards[transaction.cardNumber] || {};
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${transaction.cardNumber}</td>
                    <td>${card.holderName || '-'}</td>
                    <td>+${transaction.amount.toFixed(3)}</td>
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.description || '-'}</td>
                    <td>${formatTime(transaction.timestamp)}</td>
                `;
                rechargesTbody.appendChild(row);
            });
        }

        // تحديث جدول الإحصائيات
        function updateStatisticsTable() {
            const tbody = document.getElementById('statistics-table-body');
            tbody.innerHTML = '';
            
            for (const cardNumber in appData.cards) {
                const card = appData.cards[cardNumber];
                
                let totalWithdrawal = 0;
                let totalRecharge = 0;
                let transactionCount = 0;
                
                appData.transactions.forEach(transaction => {
                    if (transaction.cardNumber === cardNumber) {
                        transactionCount++;
                        if (transaction.type === 'withdrawal') {
                            totalWithdrawal += transaction.amount;
                        } else if (transaction.type === 'recharge') {
                            totalRecharge += transaction.amount;
                        }
                    }
                });
                
                const avgDailyWithdrawal = transactionCount > 0 ? totalWithdrawal / 30 : 0;
                const netMovement = totalRecharge - totalWithdrawal;
                
                const totalWithdrawalDisplay = totalWithdrawal !== 0 ? totalWithdrawal.toFixed(3) : '-';
                const totalRechargeDisplay = totalRecharge !== 0 ? totalRecharge.toFixed(3) : '-';
                const netMovementDisplay = netMovement !== 0 ? netMovement.toFixed(3) : '-';
                const avgDailyDisplay = avgDailyWithdrawal !== 0 ? avgDailyWithdrawal.toFixed(3) : '-';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${card.cardNumber}</td>
                    <td class="with-negative">${totalWithdrawalDisplay}</td>
                    <td>${totalRechargeDisplay}</td>
                    <td>${netMovementDisplay}</td>
                    <td>${avgDailyDisplay}</td>
                    <td>${transactionCount}</td>
                `;
                tbody.appendChild(row);
            }
        }

        // تحديث جدول النسخ الاحتياطية
        function updateBackupTable() {
            const tbody = document.getElementById('backup-table-body');
            tbody.innerHTML = '';
            
            if (backupData.backups.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td colspan="6" style="text-align: center; padding: 20px;" class="empty-cell">
                        لا توجد نسخ احتياطية متاحة
                    </td>
                `;
                tbody.appendChild(row);
                document.getElementById('last-backup-time').textContent = 'لم يتم بعد';
                document.getElementById('backup-count').textContent = '0';
                updateQuickRestoreSelect();
                return;
            }
            
            // ترتيب النسخ من الأحدث إلى الأقدم
            backupData.backups.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            backupData.backups.forEach((backup, index) => {
                const row = document.createElement('tr');
                const dataSize = JSON.stringify(backup.data).length;
                const sizeKB = (dataSize / 1024).toFixed(2);
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <strong>${formatDate(backup.date)}</strong><br>
                        <small style="color: #666;">${formatTime(backup.date)}</small>
                    </td>
                    <td>${Object.keys(backup.data.cards || {}).length}</td>
                    <td>${(backup.data.transactions || []).length}</td>
                    <td>${sizeKB} ك.ب</td>
                    <td>
                        <div style="display: flex; gap: 5px; flex-wrap: wrap;">
                            <button class="btn btn-small btn-green" onclick="confirmSpecificRestore('${backup.id}')" title="استعادة هذه النسخة">
                                <i class="fas fa-undo"></i> استعادة
                            </button>
                            <button class="btn btn-small btn-blue" onclick="previewBackup('${backup.id}')" title="معاينة المحتويات">
                                <i class="fas fa-eye"></i> معاينة
                            </button>
                            <button class="btn btn-small btn-red" onclick="deleteBackup('${backup.id}')" title="حذف هذه النسخة">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            if (backupData.lastBackup) {
                document.getElementById('last-backup-time').textContent = 
                    `${formatDate(backupData.lastBackup)} ${formatTime(backupData.lastBackup)}`;
            }
            
            document.getElementById('backup-count').textContent = backupData.backups.length;
            updateQuickRestoreSelect();
        }

        // تحديث قائمة الاستعادة السريعة
        function updateQuickRestoreSelect() {
            const select = document.getElementById('quick-restore-select');
            if (!select) return;
            
            select.innerHTML = '<option value="">-- اختر نسخة للاستعادة --</option>';
            
            if (backupData.backups.length === 0) {
                select.innerHTML += '<option value="" disabled>لا توجد نسخ احتياطية</option>';
                return;
            }
            
            backupData.backups.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            backupData.backups.forEach((backup, index) => {
                const option = document.createElement('option');
                option.value = backup.id;
                const cardCount = Object.keys(backup.data.cards || {}).length;
                const transCount = (backup.data.transactions || []).length;
                option.textContent = `${index + 1}. ${formatDate(backup.date)} ${formatTime(backup.date)} (${cardCount} كروت، ${transCount} حركة)`;
                select.appendChild(option);
            });
        }

        // استعادة سريعة من القائمة المنسدلة
        async function quickRestore() {
            const backupId = document.getElementById('quick-restore-select').value;
            
            if (!backupId) {
                showAlert('الرجاء اختيار نسخة من القائمة', 'error');
                return;
            }
            
            await confirmSpecificRestore(backupId);
        }

        // عرض رسالة تنبيه
        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('alert-message');
            alertDiv.textContent = message;
            alertDiv.className = `alert ${type}`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        // تبديل التبويبات
        function switchTab(tabName) {
            // إخفاء جميع المحتويات
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // إلغاء تنشيط جميع التبويبات
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // إظهار المحتوى المحدد
            document.getElementById(tabName).classList.add('active');
            
            // تنشيط التبويب المحدد
            document.querySelectorAll('.tab').forEach(tab => {
                if (tab.getAttribute('onclick') === `switchTab('${tabName}')`) {
                    tab.classList.add('active');
                }
            });
            
            // تحديث البيانات إذا لزم الأمر
            if (tabName === 'movement-report') {
                generateReport();
            } else if (tabName === 'reports') {
                updateStatisticsTable();
            } else if (tabName === 'backup') {
                updateBackupTable();
            }
        }

        // تنسيق التاريخ
        function formatDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                if (isNaN(date.getTime())) {
                    return '-';
                }
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            } catch (error) {
                return '-';
            }
        }

        // تنسيق الوقت
        function formatTime(timestamp) {
            if (!timestamp) return '-';
            try {
                const date = new Date(timestamp);
                if (isNaN(date.getTime())) {
                    return '-';
                }
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                return `${hours}:${minutes}`;
            } catch (error) {
                return '-';
            }
        }

        // تحديث التاريخ والوقت الحالي
        function updateDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            document.getElementById('current-date').textContent = `${year}-${month}-${day}`;
            document.getElementById('current-time').textContent = `${hours}:${minutes}`;
        }

        // إظهار/إخفاء نطاق التاريخ المخصص
        function toggleCustomDateRange() {
            const period = document.getElementById('report-period').value;
            const dateRangeDiv = document.getElementById('custom-date-range');
            
            if (period === 'custom') {
                dateRangeDiv.style.display = 'block';
            } else {
                dateRangeDiv.style.display = 'none';
            }
        }

        // تعديل بيانات كارت
        function editCard(cardNumber) {
            const card = appData.cards[cardNumber];
            if (card) {
                document.getElementById('card-number-input').value = card.cardNumber;
                document.getElementById('card-holder').value = card.holderName || '';
                document.getElementById('opening-balance-input').value = card.openingBalance || '';
                document.getElementById('opening-balance-date').value = card.openingDate || '';
                
                switchTab('opening-balance');
                
                showAlert(`تم تحميل بيانات الكارت ${cardNumber} للتعديل`, 'success');
            } else {
                showAlert(`الكارت ${cardNumber} غير موجود`, 'error');
            }
        }

        // شحن من الجدول
        function rechargeFromTable(cardNumber) {
            document.getElementById('recharge-card-input').value = cardNumber;
            switchTab('recharge-cards');
        }

        // حفظ الرصيد الافتتاحي
        async function saveOpeningBalance() {
            const cardNumber = document.getElementById('card-number-input').value.trim();
            const holderName = document.getElementById('card-holder').value.trim();
            const openingDate = document.getElementById('opening-balance-date').value;
            const openingBalance = parseFloat(document.getElementById('opening-balance-input').value) || 0;
            
            if (!cardNumber) {
                showAlert('الرجاء إدخال رقم الكارت', 'error');
                return;
            }
            
            if (!openingDate) {
                showAlert('الرجاء اختيار تاريخ التسجيل', 'error');
                return;
            }
            
            if (openingBalance < 0) {
                showAlert('الرصيد الافتتاحي لا يمكن أن يكون سالباً', 'error');
                return;
            }
            
            if (!appData.cards[cardNumber]) {
                showAlert('الكارت غير موجود', 'error');
                return;
            }
            
            // تحديث بيانات الكارت
            appData.cards[cardNumber].holderName = holderName;
            appData.cards[cardNumber].openingBalance = openingBalance;
            appData.cards[cardNumber].openingDate = openingDate;
            
            // تحديث الرصيد الحالي إذا كان صفرًا فقط
            if (appData.cards[cardNumber].currentBalance === 0) {
                appData.cards[cardNumber].currentBalance = openingBalance;
            }
            
            appData.cards[cardNumber].updatedAt = new Date().toISOString();
            
            await saveData();
            updateUI();
            
            showAlert(`تم حفظ الرصيد الافتتاحي للكارت ${cardNumber}`, 'success');
            
            // إعادة تعيين النموذج
            document.getElementById('card-number-input').value = '';
            document.getElementById('card-holder').value = '';
            document.getElementById('opening-balance-input').value = '';
            document.getElementById('opening-balance-date').value = '';
        }

        // إظهار نافذة إضافة كارت جديد
        function showAddCardModal() {
            document.getElementById('new-card-modal').style.display = 'flex';
        }

        // إخفاء نافذة إضافة كارت جديد
        function hideAddCardModal() {
            document.getElementById('new-card-modal').style.display = 'none';
            document.getElementById('new-card-number').value = '';
            document.getElementById('new-card-holder').value = '';
        }

        // حفظ كارت جديد
        async function saveNewCard() {
            const newCardNumber = document.getElementById('new-card-number').value.trim();
            const newCardHolder = document.getElementById('new-card-holder').value.trim();
            
            if (!newCardNumber) {
                showAlert('الرجاء إدخال رقم الكارت', 'error');
                return;
            }
            
            if (appData.cards[newCardNumber]) {
                showAlert('رقم الكارت موجود مسبقاً', 'error');
                return;
            }
            
            appData.cards[newCardNumber] = {
                cardNumber: newCardNumber,
                holderName: newCardHolder,
                openingBalance: 0,
                currentBalance: 0,
                openingDate: new Date().toISOString().split('T')[0],
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            await saveData();
            updateUI();
            hideAddCardModal();
            
            showAlert(`تم إضافة الكارت الجديد ${newCardNumber}`, 'success');
        }

        // حفظ عملية السحب
        async function saveWithdrawal() {
            const cardNumber = document.getElementById('withdraw-card-input').value.trim();
            const date = document.getElementById('withdraw-date').value || new Date().toISOString().split('T')[0];
            const amount = parseFloat(document.getElementById('withdraw-amount').value) || 0;
            const description = document.getElementById('withdraw-description').value;
            
            if (!cardNumber) {
                showAlert('الرجاء إدخال رقم الكارت', 'error');
                return;
            }
            
            if (!amount || amount <= 0) {
                showAlert('الرجاء إدخال مبلغ سحب صحيح', 'error');
                return;
            }
            
            const card = appData.cards[cardNumber];
            if (!card) {
                showAlert('الكارت غير موجود', 'error');
                return;
            }
            
            if (card.currentBalance < amount) {
                showAlert('الرصيد غير كافٍ لإتمام عملية السحب', 'error');
                return;
            }
            
            const transaction = {
                id: Date.now(),
                cardNumber: cardNumber,
                type: 'withdrawal',
                amount: amount,
                date: date,
                description: description,
                timestamp: new Date().toISOString()
            };
            
            card.currentBalance -= amount;
            card.updatedAt = new Date().toISOString();
            
            appData.transactions.push(transaction);
            await saveData();
            updateUI();
            
            showAlert(`تم سحب ${amount.toFixed(3)} من الكارت ${cardNumber}`, 'success');
            
            document.getElementById('withdraw-amount').value = '';
            document.getElementById('withdraw-description').value = '';
        }

        // حفظ عملية الشحن
        async function saveRecharge() {
            const cardNumber = document.getElementById('recharge-card-input').value.trim();
            const date = document.getElementById('recharge-date').value || new Date().toISOString().split('T')[0];
            const amount = parseFloat(document.getElementById('recharge-amount').value) || 0;
            const description = document.getElementById('recharge-description').value;
            
            if (!cardNumber) {
                showAlert('الرجاء إدخال رقم الكارت', 'error');
                return;
            }
            
            if (!amount || amount <= 0) {
                showAlert('الرجاء إدخال مبلغ شحن صحيح', 'error');
                return;
            }
            
            const card = appData.cards[cardNumber];
            if (!card) {
                showAlert('الكارت غير موجود', 'error');
                return;
            }
            
            const transaction = {
                id: Date.now(),
                cardNumber: cardNumber,
                type: 'recharge',
                amount: amount,
                date: date,
                description: description,
                timestamp: new Date().toISOString()
            };
            
            card.currentBalance += amount;
            card.updatedAt = new Date().toISOString();
            
            appData.transactions.push(transaction);
            await saveData();
            updateUI();
            
            showAlert(`تم شحن ${amount.toFixed(3)} للكارت ${cardNumber}`, 'success');
            
            document.getElementById('recharge-amount').value = '';
            document.getElementById('recharge-description').value = '';
        }

        // توليد تقرير الحركة
        function generateReport() {
            const cardNumber = document.getElementById('report-card-input').value.trim();
            const period = document.getElementById('report-period').value;
            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            
            if (!cardNumber) {
                document.getElementById('report-title').textContent = 'الرجاء إدخال رقم الكارت لعرض التقرير';
                document.getElementById('report-table-body').innerHTML = '';
                return;
            }
            
            const card = appData.cards[cardNumber];
            if (!card) {
                document.getElementById('report-title').textContent = `الكارت ${cardNumber} غير موجود`;
                document.getElementById('report-table-body').innerHTML = '';
                return;
            }
            
            document.getElementById('report-title').textContent = `كشف حركة الكارت ${cardNumber} ${card.holderName ? `(${card.holderName})` : ''}`;
            
            let filteredTransactions = appData.transactions.filter(t => t.cardNumber === cardNumber);
            
            if (period !== 'all') {
                const now = new Date();
                let startFilterDate, endFilterDate;
                
                switch (period) {
                    case 'today':
                        startFilterDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                        endFilterDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                        break;
                    case 'week':
                        startFilterDate = new Date(now);
                        startFilterDate.setDate(now.getDate() - now.getDay());
                        endFilterDate = new Date(now);
                        endFilterDate.setDate(now.getDate() + (6 - now.getDay()));
                        endFilterDate.setHours(23, 59, 59);
                        break;
                    case 'month':
                        startFilterDate = new Date(now.getFullYear(), now.getMonth(), 1);
                        endFilterDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                        break;
                    case 'year':
                        startFilterDate = new Date(now.getFullYear(), 0, 1);
                        endFilterDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
                        break;
                    case 'custom':
                        if (!startDate || !endDate) {
                            showAlert('الرجاء تحديد تاريخ البداية والنهاية', 'error');
                            return;
                        }
                        startFilterDate = new Date(startDate);
                        endFilterDate = new Date(endDate);
                        endFilterDate.setHours(23, 59, 59);
                        break;
                    default:
                        startFilterDate = null;
                        endFilterDate = null;
                }
                
                if (startFilterDate && endFilterDate) {
                    filteredTransactions = filteredTransactions.filter(t => {
                        const transactionDate = new Date(t.date);
                        return transactionDate >= startFilterDate && transactionDate <= endFilterDate;
                    });
                }
            }
            
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const tbody = document.getElementById('report-table-body');
            tbody.innerHTML = '';
            
            let runningBalance = card.openingBalance;
            let totalWithdrawals = 0;
            let totalRecharges = 0;
            
            // الصف الافتتاحي
            if (card.openingBalance && card.openingBalance !== 0) {
                const openingRow = document.createElement('tr');
                openingRow.style.backgroundColor = '#f9f9f9';
                openingRow.innerHTML = `
                    <td>${card.openingDate || formatDate(card.createdAt)}</td>
                    <td><strong>رصيد افتتاحي</strong></td>
                    <td>${card.openingBalance.toFixed(3)}</td>
                    <td>بداية الرصيد</td>
                    <td>${runningBalance.toFixed(3)}</td>
                `;
                tbody.appendChild(openingRow);
            }
            
            // جميع الحركات
            filteredTransactions.forEach(transaction => {
                if (transaction.type === 'withdrawal') {
                    runningBalance -= transaction.amount;
                    totalWithdrawals += transaction.amount;
                } else if (transaction.type === 'recharge') {
                    runningBalance += transaction.amount;
                    totalRecharges += transaction.amount;
                }
                
                const row = document.createElement('tr');
                const amountClass = transaction.type === 'withdrawal' ? 'withdrawal-amount' : 'recharge-amount';
                const amountSign = transaction.type === 'withdrawal' ? '-' : '+';
                
                row.innerHTML = `
                    <td>${formatDate(transaction.date)}</td>
                    <td>${transaction.type === 'withdrawal' ? 'سحب' : 'شحن'}</td>
                    <td class="${amountClass}">${amountSign}${transaction.amount.toFixed(3)}</td>
                    <td>${transaction.description || '-'}</td>
                    <td>${runningBalance.toFixed(3)}</td>
                `;
                tbody.appendChild(row);
            });
            
            // صف الإجماليات (صف واحد)
            const summaryRow = document.createElement('tr');
            summaryRow.className = 'summary-row';
            summaryRow.innerHTML = `
                <td colspan="2"><strong>الإجماليات:</strong></td>
                <td>
                    <span style="color: #00aa44;">${totalRecharges.toFixed(3)}</span> 
                    / 
                    <span style="color: #ff4444;">${totalWithdrawals.toFixed(3)}</span>
                    = 
                    <strong>${(totalRecharges - totalWithdrawals).toFixed(3)}</strong>
                </td>
                <td><strong>الرصيد النهائي:</strong></td>
                <td><strong>${runningBalance.toFixed(3)}</strong></td>
            `;
            tbody.appendChild(summaryRow);
        }

        // معاينة محتويات النسخة الاحتياطية
        function previewBackup(backupId) {
            const backup = backupData.backups.find(b => b.id === backupId);
            if (!backup) {
                showAlert('النسخة المحددة غير موجودة', 'error');
                return;
            }
            
            const cardCount = Object.keys(backup.data.cards || {}).length;
            const transCount = (backup.data.transactions || []).length;
            const recentCards = Object.keys(backup.data.cards || {}).slice(0, 5);
            const recentTransactions = (backup.data.transactions || []).slice(-5).reverse();
            
            let previewHTML = `
                <div style="max-width: 600px; max-height: 400px; overflow-y: auto; padding: 10px;">
                    <h3 style="color: var(--accent-blue); margin-bottom: 15px; text-align: center;">معاينة النسخة الاحتياطية</h3>
                    <div style="background: #f5f5f5; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                        <p><strong>تاريخ النسخة:</strong> ${formatDate(backup.date)} ${formatTime(backup.date)}</p>
                        <p><strong>عدد الكروت:</strong> ${cardCount}</p>
                        <p><strong>عدد الحركات:</strong> ${transCount}</p>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px;">أحدث 5 كروت:</h4>
                        <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
            `;
            
            if (recentCards.length > 0) {
                previewHTML += '<ul style="list-style: none; padding: 0; margin: 0;">';
                recentCards.forEach(cardNumber => {
                    const card = backup.data.cards[cardNumber];
                    previewHTML += `
                        <li style="padding: 8px 0; border-bottom: 1px solid #eee; display: flex; justify-content: space-between;">
                            <div>
                                <div style="font-weight: bold;">${cardNumber}</div>
                                <div style="color: #666; font-size: 0.9em;">${card.holderName || 'بدون اسم'}</div>
                            </div>
                            <div style="color: #1565C0; font-weight: bold;">${card.currentBalance.toFixed(3)}</div>
                        </li>
                    `;
                });
                if (cardCount > 5) {
                    previewHTML += `<li style="padding: 8px 0; color: #666; text-align: center;">و ${cardCount - 5} كروت أخرى...</li>`;
                }
                previewHTML += '</ul>';
            } else {
                previewHTML += '<p style="color: #999; font-style: italic; text-align: center;">لا توجد كروت</p>';
            }
            
            previewHTML += `
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <h4 style="margin-bottom: 10px;">أحدث 5 حركات:</h4>
                        <div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
            `;
            
            if (recentTransactions.length > 0) {
                previewHTML += '<ul style="list-style: none; padding: 0; margin: 0;">';
                recentTransactions.forEach(trans => {
                    const isWithdrawal = trans.type === 'withdrawal';
                    previewHTML += `
                        <li style="padding: 8px 0; border-bottom: 1px solid #eee;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-weight: bold;">${formatDate(trans.date)}</div>
                                    <div style="color: #666; font-size: 0.9em;">${trans.cardNumber}</div>
                                    <div style="color: #666; font-size: 0.9em;">${trans.description || 'بدون وصف'}</div>
                                </div>
                                <div style="color: ${isWithdrawal ? '#ff4444' : '#00aa44'}; font-weight: bold;">
                                    ${isWithdrawal ? '-' : '+'}${trans.amount.toFixed(3)}
                                    <div style="color: #666; font-size: 0.8em;">${isWithdrawal ? 'سحب' : 'شحن'}</div>
                                </div>
                            </div>
                        </li>
                    `;
                });
                if (transCount > 5) {
                    previewHTML += `<li style="padding: 8px 0; color: #666; text-align: center;">و ${transCount - 5} حركة أخرى...</li>`;
                }
                previewHTML += '</ul>';
            } else {
                previewHTML += '<p style="color: #999; font-style: italic; text-align: center;">لا توجد حركات</p>';
            }
            
            previewHTML += `
                        </div>
                    </div>
                </div>
            `;
            
            // عرض النافذة المنبثقة
            const modal = document.createElement('div');
            modal.id = 'preview-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background-color: rgba(0,0,0,0.5);
                z-index: 1000;
                display: flex;
                align-items: center;
                justify-content: center;
            `;
            
            modal.innerHTML = `
                <div style="background-color: white; padding: 25px; border-radius: var(--border-radius); width: 90%; max-width: 650px; max-height: 80vh; overflow: auto;">
                    ${previewHTML}
                    <div style="text-align: center; margin-top: 20px; display: flex; justify-content: center; gap: 10px;">
                        <button class="btn btn-green" onclick="confirmSpecificRestore('${backupId}')">
                            <i class="fas fa-undo"></i> استعادة هذه النسخة
                        </button>
                        <button class="btn btn-blue" onclick="closePreviewModal()">
                            <i class="fas fa-times"></i> إغلاق
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            document.getElementById('preview-modal').style.display = 'flex';
            
            // إغلاق عند النقر خارج النافذة
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    closePreviewModal();
                }
            });
        }

        // إغلاق نافذة المعاينة
        function closePreviewModal() {
            const modal = document.getElementById('preview-modal');
            if (modal) {
                modal.style.display = 'none';
                setTimeout(() => modal.remove(), 300);
            }
        }

        // تأكيد استعادة نسخة محددة مع عرض التفاصيل
        async function confirmSpecificRestore(backupId) {
            const backup = backupData.backups.find(b => b.id === backupId);
            if (!backup) {
                showAlert('النسخة المحددة غير موجودة', 'error');
                return;
            }
            
            const cardCount = Object.keys(backup.data.cards || {}).length;
            const transCount = (backup.data.transactions || []).length;
            const backupDate = formatDate(backup.date) + ' ' + formatTime(backup.date);
            
            const confirmationMessage = `
تأكيد استعادة النسخة الاحتياطية

تفاصيل النسخة:
• التاريخ: ${backupDate}
• عدد الكروت: ${cardCount} كارت
• عدد الحركات: ${transCount} حركة

تنبيه: سيتم استبدال جميع البيانات الحالية بهذه النسخة.
يتم حفظ نسخة احتياطية من البيانات الحالية تلقائياً قبل الاستعادة.

هل أنت متأكد من الاستعادة؟
            `;
            
            if (confirm(confirmationMessage)) {
                await restoreSpecificBackup(backupId);
            }
        }

        // إنشاء نسخة احتياطية
        async function createBackup() {
            try {
                const backup = {
                    id: Date.now().toString(),
                    date: new Date().toISOString(),
                    data: JSON.parse(JSON.stringify(appData)) // نسخة عميقة من البيانات
                };
                
                if (isElectron) {
                    // إنشاء نسخة احتياطية كاملة في ملف منفصل
                    const result = await window.electronAPI.createFullBackup(backup);
                    
                    if (result.success) {
                        // إضافة إلى القائمة
                        backupData.backups.push({
                            id: backup.id,
                            date: backup.date,
                            filePath: result.filePath
                        });
                    } else {
                        showAlert('فشل في إنشاء النسخة الاحتياطية', 'error');
                        return;
                    }
                } else {
                    // في حالة الويب، إضافة إلى قائمة النسخ المحلية
                    backupData.backups.push(backup);
                }
                
                backupData.lastBackup = new Date().toISOString();
                
                // الاحتفاظ بعدد النسخ المحدد في الإعدادات
                if (backupData.backups.length > backupSettings.maxBackupsToKeep) {
                    backupData.backups = backupData.backups.slice(-backupSettings.maxBackupsToKeep);
                }
                
                await saveBackupData();
                updateBackupTable();
                
                showAlert('تم إنشاء نسخة احتياطية بنجاح', 'success');
            } catch (error) {
                console.error('Error creating backup:', error);
                showAlert('حدث خطأ في إنشاء النسخة الاحتياطية', 'error');
            }
        }

        // التحقق من النسخ الاحتياطي التلقائي
        function checkAutoBackup() {
            const now = new Date();
            const lastBackupTime = backupData.lastBackup ? new Date(backupData.lastBackup) : null;
            
            // إذا مر أكثر من الوقت المحدد في الإعدادات منذ آخر نسخة احتياطية، قم بإنشاء نسخة جديدة
            if (!lastBackupTime || (now - lastBackupTime) > (backupSettings.autoBackupIntervalHours * 60 * 60 * 1000)) {
                createBackup();
            }
        }

        // استعادة نسخة احتياطية (نافذة متقدمة)
        function restoreBackup() {
            if (backupData.backups.length === 0) {
                showAlert('لا توجد نسخ احتياطية متاحة للاستعادة', 'error');
                return;
            }
            
            const select = document.getElementById('backup-select');
            select.innerHTML = '<option value="">-- اختر نسخة --</option>';
            
            backupData.backups.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            backupData.backups.forEach((backup, index) => {
                const option = document.createElement('option');
                option.value = backup.id;
                const cardCount = Object.keys(backup.data.cards || {}).length;
                const transCount = (backup.data.transactions || []).length;
                option.textContent = `النسخة ${index + 1}: ${formatDate(backup.date)} ${formatTime(backup.date)} (${cardCount} كروت، ${transCount} حركة)`;
                select.appendChild(option);
            });
            
            document.getElementById('restore-modal').style.display = 'flex';
        }

        // إخفاء نافذة الاستعادة
        function hideRestoreModal() {
            document.getElementById('restore-modal').style.display = 'none';
            document.getElementById('backup-select').innerHTML = '<option value="">-- اختر نسخة --</option>';
            document.getElementById('restore-alert').style.display = 'none';
        }

        // تأكيد الاستعادة
        async function confirmRestore() {
            const backupId = document.getElementById('backup-select').value;
            const alertDiv = document.getElementById('restore-alert');
            
            if (!backupId) {
                alertDiv.textContent = 'الرجاء اختيار نسخة للاستعادة';
                alertDiv.className = 'alert error';
                alertDiv.style.display = 'block';
                return;
            }
            
            const backup = backupData.backups.find(b => b.id === backupId);
            if (!backup) {
                alertDiv.textContent = 'النسخة المحددة غير موجودة';
                alertDiv.className = 'alert error';
                alertDiv.style.display = 'block';
                return;
            }
            
            const cardCount = Object.keys(backup.data.cards || {}).length;
            const transCount = (backup.data.transactions || []).length;
            
            const confirmationMessage = `
هل أنت متأكد من استعادة النسخة الاحتياطية؟

تفاصيل النسخة:
- التاريخ: ${formatDate(backup.date)} ${formatTime(backup.date)}
- عدد الكروت: ${cardCount}
- عدد الحركات: ${transCount}

سيتم استبدال جميع البيانات الحالية ولا يمكن التراجع عن هذا الإجراء.
            `;
            
            if (confirm(confirmationMessage)) {
                await restoreSpecificBackup(backupId);
                hideRestoreModal();
            }
        }

        // استعادة نسخة محددة (وظيفة محسنة)
        async function restoreSpecificBackup(backupId) {
            const backup = backupData.backups.find(b => b.id === backupId);
            if (!backup) {
                showAlert('النسخة المحددة غير موجودة', 'error');
                return;
            }
            
            try {
                // حفظ نسخة احتياطية من البيانات الحالية قبل الاستعادة
                const currentBackup = {
                    id: 'pre-restore-' + Date.now().toString(),
                    date: new Date().toISOString(),
                    data: JSON.parse(JSON.stringify(appData))
                };
                
                // إضافة نسخة من البيانات الحالية إلى قائمة النسخ
                backupData.backups.push(currentBackup);
                if (backupData.backups.length > backupSettings.maxBackupsToKeep) {
                    backupData.backups = backupData.backups.slice(-backupSettings.maxBackupsToKeep);
                }
                await saveBackupData();
                
                // استعادة البيانات
                appData = JSON.parse(JSON.stringify(backup.data));
                await saveData();
                
                // تحديث الواجهة
                updateUI();
                updateBackupTable();
                
                showAlert(`تم استعادة النسخة الاحتياطية بنجاح (تم حفظ نسخة من البيانات الحالية تلقائياً)`, 'success');
                
                // إغلاق نافذة المعاينة إذا كانت مفتوحة
                closePreviewModal();
                
            } catch (error) {
                console.error('Error restoring backup:', error);
                showAlert('حدث خطأ أثناء استعادة النسخة الاحتياطية', 'error');
            }
        }

        // حذف نسخة احتياطية
        async function deleteBackup(backupId) {
            if (confirm('هل أنت متأكد من حذف هذه النسخة الاحتياطية؟')) {
                backupData.backups = backupData.backups.filter(b => b.id !== backupId);
                await saveBackupData();
                updateBackupTable();
                showAlert('تم حذف النسخة الاحتياطية بنجاح', 'success');
            }
        }

        // إعادة ضبط النظام
        async function resetSystem() {
            if (confirm('هل أنت متأكد من إعادة ضبط النظام؟ سيتم حذف جميع البيانات ولا يمكن التراجع عن هذا الإجراء.')) {
                if (isElectron) {
                    // في Electron، إعادة التهيئة فقط
                    appData = {
                        cards: {},
                        transactions: []
                    };
                    backupData = {
                        backups: [],
                        lastBackup: null
                    };
                    
                    initialCards.forEach(cardNumber => {
                        appData.cards[cardNumber] = {
                            cardNumber: cardNumber,
                            holderName: "",
                            openingBalance: 0,
                            currentBalance: 0,
                            openingDate: new Date().toISOString().split('T')[0],
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString()
                        };
                    });
                    
                    await saveData();
                    await saveBackupData();
                    loadData();
                } else {
                    // في الويب، استخدام localStorage
                    localStorage.removeItem('fuelCardSystem');
                    localStorage.removeItem('fuelCardBackup');
                    localStorage.removeItem('backupSettings');
                    location.reload();
                }
            }
        }

        // دالة تنسيق التاريخ ميلادي + أرقام إنجليزية
        function formatDate(date) {
            const d = new Date(date);
            return (
                d.getFullYear() + "-" +
                String(d.getMonth() + 1).padStart(2, "0") + "-" +
                String(d.getDate()).padStart(2, "0")
            );
        }

        // تصدير إلى PDF
        async function exportToPDF() {
            const cardNumber = document.getElementById("report-card-input").value.trim();
            if (!cardNumber) return showAlert("الرجاء إدخال رقم الكارت", "error");

            const card = appData.cards[cardNumber];
            if (!card) return showAlert("الكارت غير موجود", "error");

            function formatDate(d) {
                d = new Date(d);
                return d.getFullYear() + "-" +
                    String(d.getMonth() + 1).padStart(2, "0") + "-" +
                    String(d.getDate()).padStart(2, "0");
            }

            try {
                const reportElement = document.createElement("div");
                reportElement.id = "pdf-report-container";

                reportElement.style.cssText = `
                    width: 794px;
                    min-height: 1100px;
                    margin: 0;
                    padding: 0;
                    box-sizing: border-box;
                    background: white;
                    direction: rtl;
                    text-align: right;
                    font-family: 'Cairo', sans-serif;
                    overflow: visible !important;
                    position: relative;
                    unicode-bidi: plaintext;
                    page-break-inside: avoid;
                `;

                // تحميل خط عربي
                const fontStyle = document.createElement("style");
                fontStyle.innerHTML = `
                    @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap');
                    * { font-family: 'Cairo', sans-serif !important; }
                `;
                document.head.appendChild(fontStyle);

                // معاملات الكارت
                let trans = appData.transactions.filter(t => t.cardNumber === cardNumber);
                trans.sort((a, b) => new Date(a.date) - new Date(b.date));

                let runningBalance = card.openingBalance || 0;
                let totalWithdraw = 0;
                let totalRecharge = 0;

                // بناء التقرير
                let html = `
                    <div style="padding: 10px 20px 0 20px; margin: 0;">
                        <h2 style="text-align:center; margin:0;">شركة نايف للأغذية</h2>
                        <h3 style="text-align:center; margin:0;">نظام إدارة كروت شحن البنزين</h3>
                        <h4 style="text-align:center; margin:0 0 10px 0;">الكويت</h4>

                        <div style="background:#eee; padding:10px; border-radius:4px; margin-bottom:10px; font-size:14px;">
                            <strong>رقم الكارت:</strong> ${cardNumber}<br>
                            <strong>اسم الحامل:</strong> ${card.holderName || "غير محدد"}<br>
                            <strong>الرصيد الافتتاحي:</strong> ${runningBalance.toFixed(3)}<br>
                            <strong>تاريخ التقرير:</strong> ${formatDate(new Date())}
                        </div>
                    </div>

                    <table style="
                        width:93%;
                        border-collapse: collapse;
                        font-size:13px;
                        direction: rtl;
                        text-align: right;
                        margin: 0;
                        padding: 0;
                        margin-right: 6mm;
                    ">
                        <thead>
                            <tr style="background:#1565C0; color:white;">
                                <th style="padding:8px; border:1px solid #ddd;">التاريخ</th>
                                <th style="padding:8px; border:1px solid #ddd;">النوع</th>
                                <th style="padding:8px; border:1px solid #ddd;">المبلغ</th>
                                <th style="padding:8px; border:1px solid #ddd;">الوصف</th>
                                <th style="padding:8px; border:1px solid #ddd;">الرصيد بعد</th>
                            </tr>
                        </thead>
                        <tbody>
                `;

                // رصيد افتتاحي
                html += `
                    <tr style="background:#e9f3ff;">
                        <td style="padding:6px; border:1px solid #ddd;">${formatDate(card.createdAt)}</td>
                        <td style="padding:6px; border:1px solid #ddd;">رصيد افتتاحي</td>
                        <td style="padding:6px; border:1px solid #ddd;">${runningBalance.toFixed(3)}</td>
                        <td style="padding:6px; border:1px solid #ddd;">بداية الرصيد</td>
                        <td style="padding:6px; border:1px solid #ddd;">${runningBalance.toFixed(3)}</td>
                    </tr>
                `;

                // الحركات
                trans.forEach(t => {
                    if (t.type === "withdrawal") {
                        runningBalance -= t.amount;
                        totalWithdraw += t.amount;
                    } else {
                        runningBalance += t.amount;
                        totalRecharge += t.amount;
                    }

                    html += `
                        <tr>
                            <td style="padding:6px; border:1px solid #ddd;">${formatDate(t.date)}</td>
                            <td style="padding:6px; border:1px solid #ddd;">${t.type === "withdrawal" ? "سحب" : "شحن"}</td>
                            <td style="padding:6px; border:1px solid #ddd; color:${t.type === "withdrawal" ? "red" : "green"};">
                                ${t.type === "withdrawal" ? "-" : "+"}${t.amount.toFixed(3)}
                            </td>
                            <td style="padding:6px; border:1px solid #ddd;">${t.description || "-"}</td>
                            <td style="padding:6px; border:1px solid #ddd;">${runningBalance.toFixed(3)}</td>
                        </tr>
                    `;
                });

                // الإجمالي
                html += `
                    <tr style="background:#eef7ff; font-weight:bold;">
                        <td colspan="2" style="padding:8px; border:1px solid #ddd;">الإجماليات</td>
                        <td style="padding:8px; border:1px solid #ddd;">
                            +${totalRecharge.toFixed(3)} / -${totalWithdraw.toFixed(3)}
                        </td>
                        <td style="padding:8px; border:1px solid #ddd;">الرصيد النهائي</td>
                        <td style="padding:8px; border:1px solid #ddd; color:#1565C0;">
                            ${runningBalance.toFixed(3)}
                        </td>
                    </tr>
                `;

                html += "</tbody></table>";

                reportElement.innerHTML = html;
                document.body.appendChild(reportElement);

                // إعدادات PDF
                await html2pdf().set({
                    margin: 0,
                    filename: `report_${cardNumber}.pdf`,
                    image: { type: "jpeg", quality: 1 },
                    html2canvas: {
                        scale: 2,
                        useCORS: true,
                        backgroundColor: "#ffffff"
                    },
                    jsPDF: { unit: "mm", format: "a4", orientation: "portrait" }
                }).from(reportElement).save();

                document.body.removeChild(reportElement);

            } catch (e) {
                console.error(e);
                showAlert("خطأ أثناء تصدير PDF", "error");
            }
        }

        // تصدير إلى Excel
        function exportToExcel() {
            const cardNumber = document.getElementById('report-card-input').value.trim();
            if (!cardNumber) {
                showAlert('الرجاء إدخال رقم الكارت لتصدير التقرير', 'error');
                return;
            }
            
            const card = appData.cards[cardNumber];
            if (!card) {
                showAlert('الكارت غير موجود', 'error');
                return;
            }
            
            try {
                // البيانات للتصدير
                const period = document.getElementById('report-period').value;
                let filteredTransactions = appData.transactions.filter(t => t.cardNumber === cardNumber);
                
                if (period !== 'all') {
                    const now = new Date();
                    let startFilterDate, endFilterDate;
                    
                    switch (period) {
                        case 'today':
                            startFilterDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                            endFilterDate = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 23, 59, 59);
                            break;
                        case 'week':
                            startFilterDate = new Date(now);
                            startFilterDate.setDate(now.getDate() - now.getDay());
                            endFilterDate = new Date(now);
                            endFilterDate.setDate(now.getDate() + (6 - now.getDay()));
                            endFilterDate.setHours(23, 59, 59);
                            break;
                        case 'month':
                            startFilterDate = new Date(now.getFullYear(), now.getMonth(), 1);
                            endFilterDate = new Date(now.getFullYear(), now.getMonth() + 1, 0, 23, 59, 59);
                            break;
                        case 'year':
                            startFilterDate = new Date(now.getFullYear(), 0, 1);
                            endFilterDate = new Date(now.getFullYear(), 11, 31, 23, 59, 59);
                            break;
                        case 'custom':
                            const startDate = document.getElementById('start-date').value;
                            const endDate = document.getElementById('end-date').value;
                            if (startDate && endDate) {
                                startFilterDate = new Date(startDate);
                                endFilterDate = new Date(endDate);
                                endFilterDate.setHours(23, 59, 59);
                            }
                            break;
                    }
                    
                    if (startFilterDate && endFilterDate) {
                        filteredTransactions = filteredTransactions.filter(t => {
                            const transactionDate = new Date(t.date);
                            return transactionDate >= startFilterDate && transactionDate <= endFilterDate;
                        });
                    }
                }
                
                filteredTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                let runningBalance = card.openingBalance;
                let totalWithdrawals = 0;
                let totalRecharges = 0;
                
                const data = [];
                
                // العنوان والعنوان الفرعي
                data.push(['شركة نايف للأغذية']);
                data.push(['الكويت']);
                data.push(['نظام إدارة كروت شحن البنزين']);
                data.push([]);
                data.push(['كشف حركة الكارت']);
                data.push([`رقم الكارت: ${cardNumber}`]);
                data.push([`اسم حامل الكارت: ${card.holderName || 'غير محدد'}`]);
                data.push([`الرصيد الافتتاحي: ${card.openingBalance ? card.openingBalance.toFixed(3) : '0'}`]);
                data.push([`الرصيد الحالي: ${card.currentBalance ? card.currentBalance.toFixed(3) : '0'}`]);
                data.push([`تاريخ التقرير: ${new Date().toISOString().split('T')[0]}`]);
                data.push([]);
                
                // رأس الجدول
                data.push(['التاريخ', 'نوع الحركة', 'المبلغ', 'الوصف', 'الرصيد بعد الحركة']);
                
                // الصف الافتتاحي
                if (card.openingBalance && card.openingBalance !== 0) {
                    data.push([
                        card.openingDate || formatDate(card.createdAt),
                        'رصيد افتتاحي',
                        card.openingBalance.toFixed(3),
                        'بداية الرصيد',
                        runningBalance.toFixed(3)
                    ]);
                }
                
                // جميع الحركات
                filteredTransactions.forEach(transaction => {
                    if (transaction.type === 'withdrawal') {
                        runningBalance -= transaction.amount;
                        totalWithdrawals += transaction.amount;
                    } else if (transaction.type === 'recharge') {
                        runningBalance += transaction.amount;
                        totalRecharges += transaction.amount;
                    }
                    
                    data.push([
                        formatDate(transaction.date),
                        transaction.type === 'withdrawal' ? 'سحب' : 'شحن',
                        (transaction.type === 'withdrawal' ? '-' : '+') + transaction.amount.toFixed(3),
                        transaction.description || '-',
                        runningBalance.toFixed(3)
                    ]);
                });
                
                // صف الإجماليات
                data.push([]);
                data.push([
                    'الإجماليات',
                    '',
                    `${totalRecharges.toFixed(3)} / ${totalWithdrawals.toFixed(3)} = ${(totalRecharges - totalWithdrawals).toFixed(3)}`,
                    'الرصيد النهائي',
                    runningBalance.toFixed(3)
                ]);
                
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(data);
                
                const wscols = [
                    { wch: 15 },
                    { wch: 12 },
                    { wch: 15 },
                    { wch: 40 },
                    { wch: 20 }
                ];
                ws['!cols'] = wscols;
                
                XLSX.utils.book_append_sheet(wb, ws, 'كشف الحركة');
                
                const fileName = `تقرير_كارت_${cardNumber}_${new Date().toISOString().slice(0, 10)}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                showAlert('تم تصدير التقرير بنجاح إلى Excel', 'success');
            } catch (error) {
                console.error('خطأ في تصدير Excel:', error);
                showAlert('حدث خطأ أثناء تصدير Excel', 'error');
            }
        }

        // إخفاء النوافذ المنبثقة عند النقر خارجها
        document.getElementById('new-card-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideAddCardModal();
            }
        });

        document.getElementById('restore-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                hideRestoreModal();
            }
        });

        // تهيئة التطبيق عند تحميل الصفحة
        window.onload = async function() {
            await loadData();
            updateDateTime();
            setInterval(updateDateTime, 60000);
            
            // تعيين تاريخ اليوم في حقول التاريخ
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('withdraw-date').value = today;
            document.getElementById('recharge-date').value = today;
            document.getElementById('start-date').value = today;
            document.getElementById('end-date').value = today;
            document.getElementById('opening-balance-date').value = today;
            
            console.log('تم تهيئة التطبيق بنجاح');
        };
    </script>
</body>
</html>